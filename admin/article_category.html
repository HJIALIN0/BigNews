<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>文章列表</title>
    <link rel="stylesheet" href="./libs/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/iconfont.css" />
    <link rel="stylesheet" href="css/main.css" />
    <script src="./libs/jquery-1.12.4.min.js"></script>
    <script src="./libs/bootstrap/js/bootstrap.min.js"></script>
    <!-- 引入模板引擎js文件 -->
    <script src="./libs/template-web.js"></script>
  </head>

  <body>
    <div class="container-fluid">
      <div class="common_title">
        文章类别管理
      </div>
      <div class="container-fluid common_con">
        <table
          class="table table-striped table-bordered table-hover mp20 category_table"
        >
          <thead>
            <tr>
              <th>名称</th>
              <th>Slug</th>
              <th class="text-center" width="100">操作</th>
            </tr>
          </thead>
          <tbody>
            ...
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-center">
                <a
                  class="btn btn-success"
                  id="xinzengfenlei"
                  data-toggle="modal"
                  data-target="#myModal"
                  >新增分类</a
                >
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- BS模态弹窗 -->
    <div
      class="modal fade"
      id="myModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="exampleModalLabel"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="exampleModalLabel">分类管理</h4>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="recipient-name" class="control-label"
                  >分类名称:</label
                >
                <input type="text" class="form-control" id="recipient-name" />
              </div>
              <div class="form-group">
                <label for="message-text" class="control-label"
                  >分类说明:</label
                >
                <textarea class="form-control" id="message-text"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              关闭
            </button>
            <button type="button" class="btn btn-success" id="modalSubmit">
              新增
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="./js/http.js"></script>
    <script src="./libs/http.js"></script>
    <script>
      $(function() {
        $.ajax({
          url: BigNew.category_list,
          type: "get",
          dataType: "json",
          success: function(backData) {
            // console.log(backData);
            const data = backData.data;
            const htmlStr = data.map(function(item) {
              return `<tr>
              <td>${item.name}</td>
              <td>${item.slug}</td>
              <td class="text-center">
                <a
                 data-toggle="modal"
                  data-target="#myModal"
                  class=" btn btn-info btn-xs" data-id=${item.id}
                  >编辑</a
                >
                <a  class="btn btn-danger btn-xs" data-id=${item.id} id="del"
                  >删除</a>
              </td>
            </tr>`;
            });
            $(".category_table>tbody").html(htmlStr);
          }
        });

        //模态框出现之前
        $("#myModal").on("show.bs.modal", function(e) {
          //   console.log(e.relatedTarget);
          const text = $(e.relatedTarget).text();
          $("#modalSubmit").text(text);
          if (text === "编辑") {
            //点击蓝色按钮
            const id = $(e.relatedTarget).attr("data-id");
            $("#modalSubmit").attr("data-id", id);

            $("#modalSubmit").attr("class", "btn btn-info");
            const name = $(e.relatedTarget)
              .parent()
              .prev()
              .prev()
              .text();
            const slug = $(e.relatedTarget)
              .parent()
              .prev()
              .text();
            $("#recipient-name").val(name);
            $("#message-text").val(slug);
          } else {
            //点击绿色按钮
            $("#modalSubmit").attr("class", "btn btn-success");
            $("#modal-body form").trigger("reset");
          }
        });

        //
        $("#modalSubmit").click(function() {
          const str = $(this).text();
          if (str === "新增分类") {
            $.ajax({
              type: "post",
              url: urls.category_add,
              data: {
                name: $("#recipient-name").val(),
                slug: $("#message-text").val()
              },
              dataType: "json",
              success: function(response) {
                console.log(response);
                const code = response.code;
                if (code === 201) {
                  location.reload();
                }
              }
            });
          } else if (str === "编辑") {
            const name = $("#recipient-name").val();
            const content = $("#message-text").val();
            const id = $("#modalSubmit").attr("data-id");
            $.ajax({
              type: "post",
              url: urls.category_edit,
              data: {
                id: id,
                name: name,
                slug: content
              },
              dataType: "json",
              success: function(response) {
                if (response.code === 200) {
                  location.reload();
                }
              }
            });
          }
        });

        //点击删除按钮
        $("tbody").on("click", "#del", function(e) {
          const id = $(this).attr("data-id");
          $.ajax({
            type: "post",
            url: urls.category_delete,
            data: { id },
            dataType: "json",
            success: function(response) {
              if (response.code === 204) {
                alert(response.msg);
                location.reload();
              }
            }
          });
        });
      });
    </script>
  </body>
</html>
